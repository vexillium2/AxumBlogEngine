# 用户模块测试用例设计文档

## 概述

本文档描述了用户模块（UserRepository）的测试用例设计，涵盖了用户数据库操作的各种场景，确保系统的可靠性和数据完整性。

## 测试环境

- **数据库**: SQLite 内存数据库（`sqlite::memory:`）
- **测试框架**: Rust 内置测试框架 + tokio 异步测试
- **密码哈希**: bcrypt（DEFAULT_COST）

## 测试用例分类

### 1. 用户创建测试

#### 1.1 普通用户注册 (`test_create_user_from_register`)
- **目的**: 测试通过注册接口创建普通用户
- **验证点**:
  - 用户信息正确保存
  - 默认角色为 "user"
  - 自动生成用户ID
  - 时间戳正确设置

#### 1.2 管理员创建用户 (`test_create_user_by_admin`)
- **目的**: 测试管理员创建用户功能
- **验证点**:
  - 可以指定用户角色
  - 支持创建管理员用户
  - 用户信息正确保存

### 2. 用户查询测试

#### 2.1 通过ID查询用户 (`test_get_user_by_id`)
- **目的**: 测试根据用户ID查找用户
- **验证点**:
  - 能够正确找到存在的用户
  - 返回完整的用户信息

#### 2.2 查询不存在的用户 (`test_get_user_by_id_not_found`)
- **目的**: 测试查询不存在用户的处理
- **验证点**:
  - 返回 None 而不是错误
  - 不会抛出异常

#### 2.3 通过用户名或邮箱查询 (`test_get_user_by_username_or_email`)
- **目的**: 测试登录时的用户查找功能
- **验证点**:
  - 支持用户名查找
  - 支持邮箱查找
  - 不存在用户返回 None

### 3. 用户更新测试

#### 3.1 用户自己更新资料 (`test_update_my_profile`)
- **目的**: 测试用户更新个人信息
- **验证点**:
  - 可以更新用户名、邮箱、密码
  - 密码正确哈希
  - 更新时间戳自动更新
  - 创建时间戳保持不变

#### 3.2 部分信息更新 (`test_update_my_profile_partial`)
- **目的**: 测试选择性更新用户信息
- **验证点**:
  - 只更新提供的字段
  - 未提供的字段保持原值
  - 支持 Option 类型的部分更新

#### 3.3 管理员更新用户 (`test_update_user_by_admin`)
- **目的**: 测试管理员更新用户信息
- **验证点**:
  - 可以更新所有用户信息
  - 可以修改用户角色
  - 支持角色提升/降级

#### 3.4 无效角色更新 (`test_update_user_by_admin_invalid_role`)
- **目的**: 测试角色验证机制
- **验证点**:
  - 拒绝无效角色
  - 返回适当的错误信息
  - 错误类型为 BadRequest

#### 3.5 更新不存在的用户 (`test_update_user_not_found`)
- **目的**: 测试更新不存在用户的处理
- **验证点**:
  - 返回 NotFound 错误
  - 错误信息清晰明确

### 4. 用户删除测试

#### 4.1 删除存在的用户 (`test_delete_user`)
- **目的**: 测试用户删除功能
- **验证点**:
  - 成功删除用户
  - 删除后无法查找到用户
  - 操作成功返回

#### 4.2 删除不存在的用户 (`test_delete_user_not_found`)
- **目的**: 测试删除不存在用户的处理
- **验证点**:
  - 返回 NotFound 错误
  - 错误信息准确

### 5. 数据完整性测试

#### 5.1 用户名唯一性 (`test_duplicate_username`)
- **目的**: 测试用户名唯一约束
- **验证点**:
  - 拒绝重复用户名
  - 数据库约束正确工作

#### 5.2 邮箱唯一性 (`test_duplicate_email`)
- **目的**: 测试邮箱唯一约束
- **验证点**:
  - 拒绝重复邮箱
  - 数据库约束正确工作

#### 5.3 时间戳验证 (`test_user_timestamps`)
- **目的**: 测试时间戳的正确性
- **验证点**:
  - 创建时间在合理范围内
  - 更新时间正确更新
  - 创建时间不会被修改
  - 更新时间晚于创建时间

## 测试覆盖范围

### 功能覆盖
- ✅ 用户创建（注册 + 管理员创建）
- ✅ 用户查询（ID查询 + 用户名/邮箱查询）
- ✅ 用户更新（自己更新 + 管理员更新）
- ✅ 用户删除
- ✅ 数据验证（唯一性约束）
- ✅ 时间戳管理

### 错误场景覆盖
- ✅ 查询不存在的用户
- ✅ 更新不存在的用户
- ✅ 删除不存在的用户
- ✅ 无效角色设置
- ✅ 重复用户名/邮箱

### 边界条件覆盖
- ✅ 部分字段更新
- ✅ 密码哈希验证
- ✅ 角色权限验证
- ✅ 时间戳精度验证

## 运行测试

```bash
# 运行所有用户测试
cargo test user_test

# 运行所有测试（包括详细输出）
cargo test -- --nocapture

# 运行特定测试
cargo test test_create_user_from_register
```

## 测试结果

当前所有 15 个测试用例均通过，覆盖了用户模块的核心功能和边界情况，确保了系统的稳定性和数据完整性。

## 未来扩展

可以考虑添加以下测试场景：

1. **性能测试**: 大量用户创建和查询的性能测试
2. **并发测试**: 多线程同时操作用户数据的测试
3. **数据迁移测试**: 数据库结构变更时的兼容性测试
4. **安全测试**: SQL注入、密码强度等安全相关测试
5. **集成测试**: 与其他模块（如认证、权限）的集成测试